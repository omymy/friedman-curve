<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>产程图</title>
    <link href="js/layui/css/layui.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
        }

        .title {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .title div:first-child {
            font-size: 18px;
        }

        .title div:nth-child(2) {
            font-size: 28px;
        }

        .friedman {
            text-align: center;
        }

        /* 附属表格 */
        .table {
            margin-top: 20px;
            table-layout: fixed;
            word-break: break-all;
        }

        .table table {
            width: 960px;
            margin: auto;
            /* border: #000 2px solid; */
            border-collapse: collapse;
        }

        .table table tr {
            height: 80px;
            text-align: center;
        }

        .table table td {
            width: 40px;
            border: #000 1px solid;
            padding: 4px;
        }

        /* .table table td:first-child {
            border-left-width: 2px;
        }

        .table table td:last-child {
            border-right-width: 2px;
        } */

        .table table td hr {
            border-top: 1px solid #000;
        }

        .table .vertical {
            writing-mode: vertical-lr;
            letter-spacing: 2px;
        }

        .table table tr:first-child {
            text-align: left;
            height: 20px;
        }

        .table table tr:first-child td {
            border-top: none;
            border-left: none;
            border-right: none;
            /* border-bottom-width: 2px; */
        }

        .table table tr:first-child td span {
            position: relative;
            left: -8px;
        }

        .table table tr:nth-child(5) {
            height: 330px;
        }

        .table table tr:nth-child(7) {
            text-align: left;
            vertical-align: top;
        }

        .table table tr:last-child {
            text-align: left;
            height: 40px;
        }

        .table table tr:last-child td {
            border-left: none;
            border-right: none;
            border-bottom: none;
            /* border-top-width: 2px; */
        }

        /* 附属表格左侧文字 */
        #table-title {
            position: absolute;
            top: 640px;
            left: calc(50% - 524px);
            text-align: center;
        }

        #table-title p:nth-child(3) {
            margin-top: 38px;
        }

        #table-title p:nth-child(4) {
            margin-top: 44px;
        }

        #table-title p:nth-child(5) {
            margin-top: 100px;
        }

        #table-title p:nth-child(6) {
            margin-top: 160px;
        }

        #table-title p:nth-child(7) {
            margin-top: 80px;
        }

        #add-button {
            position: absolute;
            left: calc(50% + 310px);
        }

        #print-button {
            position: absolute;
            left: calc(50% + 405px);
        }

        #dialog {
            display: none;
            padding: 20px;
        }
    </style>
    <style media="print">
        #add-button,
        #print-button {
            display: none;
        }
    </style>

    <style type="text/css">
        .layui-laydate-content>.layui-laydate-list {
            padding-bottom: 0px;
            overflow: hidden;
        }

        .layui-laydate-content>.layui-laydate-list>li {
            width: 50%
        }

        .merge-box .scrollbox .merge-list {
            padding-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="title">
        <div>
            <span>XXXXXXXXXX医院</span>
            <input id="add-button" type="button" value="数据填写" class="layui-btn layui-btn-primary" />
            <input id="print-button" type="button" value="打印" class="layui-btn layui-btn-primary" />
        </div>
        <div>产&nbsp;&nbsp;&nbsp;&nbsp;程&nbsp;&nbsp;&nbsp;&nbsp;图</div>
    </div>
    <div class="friedman">
        <canvas id="background" width="1040" height="520">
        </canvas>
    </div>
    <div class="table">
        <div id="table-title">
            <p>检查<br />时间</p>
            <p><br />血压<br />mmHg</p>
            <p>胎心<br />(次/分)</p>
            <p>宫缩</p>
            <p>处</p>
            <p>理</p>
            <p>签</p>
            <p>名</p>
        </div>
        <table>
            <tr>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
                <td><span></span></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td colspan="24">
                    备注：<span id="t_remark"></span>
                </td>
            </tr>
            <tr>
                <td colspan="8">
                    医师：
                </td>
                <td colspan="8">
                    接产者：
                </td>
                <td colspan="8">
                    巡回：
                </td>
            </tr>
        </table>
    </div>

    <div id="dialog">
        <form class="layui-form" id="form1">
            <div class="layui-form-item">
                <div class="layui-input-inline">
                    <input id="save-button" type="button" value="保存" class="layui-btn layui-btn-sm"
                        style="width: 60px;" />
                    <input id="cancel-button" type="button" value="关闭" class="layui-btn layui-btn-danger layui-btn-sm"
                        style="width: 60px;" />
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">姓名</label>
                <div class="layui-input-inline">
                    <input id="PATIENT_NAME" name="PATIENT_NAME" type="text" autocomplete="off" class="layui-input">
                </div>
                <label class="layui-form-label">年龄</label>
                <div class="layui-input-inline">
                    <input id="AGE" name="AGE" type="text" autocomplete="off" class="layui-input">
                </div>
                <label class="layui-form-label">胎次</label>
                <div class="layui-input-inline">
                    <input id="TC" name="TC" type="text" autocomplete="off" class="layui-input">
                </div>
                <label class="layui-form-label">产次</label>
                <div class="layui-input-inline">
                    <input id="CC" name="CC" type="text" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">孕次</label>
                <div class="layui-input-inline">
                    <input id="YC" name="YC" type="text" autocomplete="off" class="layui-input">
                </div>
                <label class="layui-form-label">孕周</label>
                <div class="layui-input-inline">
                    <input id="YZ" name="YZ" type="text" autocomplete="off" class="layui-input">
                </div>
                <label class="layui-form-label">孕产号</label>
                <div class="layui-input-inline">
                    <input id="MATERNITY_NUMBER" name="MATERNITY_NUMBER" type="text" autocomplete="off"
                        class="layui-input">
                </div>
                <label class="layui-form-label">病案号</label>
                <div class="layui-input-inline">
                    <input id="MEDICAL_RECORD_NUMBER" name="MEDICAL_RECORD_NUMBER" type="text" autocomplete="off"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">开始时间</label>
                <div class="layui-input-inline">
                    <input type="datetime-local" id="START_TIME" max="9999-12-31T23:59" class="layui-input" />
                </div>
                <label class="layui-form-label">备注</label>
                <div class="layui-input-inline">
                    <input id="REMARK" name="REMARK" style="width:600px" type="text" autocomplete="off"
                        class="layui-input">
                </div>
            </div>
        </form>
        <div>
            <input id="add-one-button" type="button" value="新增一行" class="layui-btn layui-btn-normal layui-btn-sm" />
        </div>
        <table class="layui-table" lay-skin="line">
            <colgroup>
                <col width="11%">
                <col width="11%">
                <col width="11%">
                <col width="11%">
                <col width="11%">
                <col width="11%">
                <col width="11%">
                <col width="23%">
            </colgroup>
            <thead>
                <tr>
                    <th>检查时间</th>
                    <th>宫口扩张</th>
                    <th>先露高低</th>
                    <th>血压</th>
                    <th></th>
                    <th>胎心</th>
                    <th>宫缩</th>
                    <th>处理</th>
                </tr>
            </thead>
            <tbody id="table-form">
            </tbody>
        </table>
    </div>
</body>

</html>
<script src="js/jquery-3.0.0.min.js"></script>
<script src="js/layui/layui.js"></script>
<script>
    let _regTime = /^([0-1]{1}\d|2[0-3]):([0-5]\d)$/; // 验证是否时间格式正则
    let _queryContent = "";
    let _defaultRow = 5;
    let _dataGJKZ = [];
    let _dataXLXJ = [];

    var canvas;
    var ctx;
    // var margin = 20;
    var space = 20; //轴的离边距离
    var xSpace = 40;
    var width;
    var height;
    var originX;
    var originY;
    var xGridSize = 48; // x10 + 40 = height
    var yGridSize = 40; // x24 + 40 = width
    var timeCount = 24;

    function init() {
        canvas = document.getElementById('background');
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        width = canvas.width - xSpace - xSpace; //减去左右两侧
        height = canvas.height - space;
        originX = xSpace;
        originY = height;
        //ctx.translate(0.5, 0.5);

        ctx.font = "14px Arial";
        ctx.lineWidth = 2;
        colorReset();

        // console.log(`originX:${originX}`);
        // console.log(`originY:${originY}`);
        // console.log(`width:${width}`);
        // console.log(`height:${height}`);

        // y轴
        drawLine(originX, originY, originX, space);
        // x轴
        drawLine(originX, originY, originX + width, originY);
        // 上横线
        drawLine(originX, space, originX + width, space);
        // 右竖线
        drawLine(originX + width, originY, originX + width, space);

        ctx.lineWidth = 1;

        // 绘制X轴方向的线
        var xCount = Math.floor(height / xGridSize);
        for (var i = 0; i < xCount; i++) {
            ctx.beginPath();
            ctx.moveTo(originX, i * xGridSize + space - 0.5);
            ctx.lineTo(originX + width, i * xGridSize + space - 0.5);
            ctx.stroke();
        }

        // 绘制Y轴方向的线
        yGridSize = Math.floor(width / timeCount);
        var yCount = Math.floor(width / yGridSize);
        for (var i = 0; i < yCount; i++) {
            ctx.beginPath();
            ctx.moveTo(i * yGridSize + xSpace - 0.5, space);
            ctx.lineTo(i * yGridSize + xSpace - 0.5, height);
            ctx.stroke();
        }
        drawTitle();
    }

    // 绘制文字及坐标值
    function drawTitle() {
        // X轴坐标值绘制
        arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
        for (var i = 0; i < arr.length; i++) {
            ctx.fillText(arr[i], i * yGridSize + 74, height + space);
        }

        // X轴上侧文字绘制
        let topY = space - 8;
        ctx.fillText('姓名：', xSpace * 2, topY);
        ctx.fillText('年龄：', xSpace * 5, topY);
        ctx.fillText('胎次：', xSpace * 7, topY);
        ctx.fillText('产次：', xSpace * 9, topY);
        ctx.fillText('孕次：', xSpace * 11, topY);
        ctx.fillText('孕周：', xSpace * 13, topY);
        ctx.fillText('孕产号：', xSpace * 15, topY);
        ctx.fillText('病案号：', xSpace * 19, topY);

        // Y轴坐标值及文字
        var arr = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0];
        for (var i = 0; i < arr.length; i++) {
            ctx.fillText(arr[i], space, xGridSize * i + 22);
        }
        ctx.fillText('宫', 0, xGridSize + 18);
        ctx.fillText('口', 0, xGridSize + 38);
        ctx.fillText('扩', 0, xGridSize + 58);
        ctx.fillText('张', 0, xGridSize + 78);
        ctx.fillText('公', 0, xGridSize + 118);
        ctx.fillText('分', 0, xGridSize + 138);
        drawCircle(7, xGridSize + 168);
        ctx.fillText('|', 5, xGridSize + 188);
        drawCircle(7, xGridSize + 200);
        ctx.fillText('红', 0, xGridSize + 240);
        ctx.fillText('色', 0, xGridSize + 260);

        // Y轴右边坐标值及文字
        arr = ['+5', '+4', '+3', '+2', '+1', '0', '-1', '-2', '-3', '-4', '-5'];
        for (var i = 0; i < arr.length; i++) {
            ctx.fillText(arr[i], originX + width + 3, xGridSize * i + 22);
        }
        ctx.fillText('先', originX + width + space + 6, xGridSize + 18);
        ctx.fillText('露', originX + width + space + 6, xGridSize + 38);
        ctx.fillText('高', originX + width + space + 6, xGridSize + 58);
        ctx.fillText('低', originX + width + space + 6, xGridSize + 78);
        drawX(originX + width + space + 11, xGridSize + 108);
        colorReset();
        ctx.fillText('|', originX + width + space + 9, xGridSize + 128);
        drawX(originX + width + space + 11, xGridSize + 142);
        colorReset();
        ctx.fillText('蓝', originX + width + space + 6, xGridSize + 182);
        ctx.fillText('色', originX + width + space + 6, xGridSize + 202);
    }

    // 宫颈扩张曲线
    function drawGJKZ() {
        ctx.strokeStyle = "#FF0000";
        ctx.beginPath();
        let axis = [];
        for (let i = 0; i < _dataGJKZ.length; i++) {
            // let x = xSpace + yGridSize * (i + 1);
            let x = _dataGJKZ[i].time * yGridSize + xSpace;
            let y = height - xGridSize * _dataGJKZ[i].value;
            if (i == 0) {
                ctx.moveTo(xSpace, y);
                axis.push({ x: xSpace, y: y, v: _dataGJKZ[i].value });
            } else if (_dataGJKZ[i].value != null) {
                ctx.lineTo(x, y);
                ctx.stroke();
                axis.push({ x: x, y: y, v: _dataGJKZ[i].value });
            }
        }

        for (let i = 0; i < axis.length; i++) {
            if (axis[i].v != null) {
                drawCircle(axis[i].x, axis[i].y);
                //ctx.fillText(axis[i].v, axis[i].x, axis[i].y - 10);
            }
        }
    }

    // 先露下降曲线
    function drawXLXJ() {
        ctx.strokeStyle = "#0000FF";
        ctx.beginPath();
        let axis = [];
        for (let i = 0; i < _dataXLXJ.length; i++) {
            _dataXLXJ[i].value = parseFloat(_dataXLXJ[i].value) + 5;
            // let x = xSpace + yGridSize * (i + 1);
            let x = _dataXLXJ[i].time * yGridSize + xSpace;
            let y = height - xGridSize * _dataXLXJ[i].value;
            if (i == 0) {
                ctx.moveTo(xSpace, y);
                axis.push({ x: xSpace, y: y, v: _dataXLXJ[i].value - 5 });
            } else if (_dataXLXJ[i].value != null) {
                ctx.lineTo(x, y);
                ctx.stroke();
                axis.push({ x: x, y: y, v: _dataXLXJ[i].value - 5 });
            }
        }

        for (let i = 0; i < axis.length; i++) {
            if (axis[i].v != null) {
                drawX(axis[i].x, axis[i].y);
            }
        }
    }

    // 红色圆圈
    function drawCircle(x, y) {
        ctx.strokeStyle = "#FF0000";
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, 2 * Math.PI);

        // ctx.fillStyle = "#FF0000";
        // ctx.fill(); //填充实心

        ctx.stroke();
    }

    // 五角星
    function drawStar(x, y) {
        ctx.beginPath();
        var horn = 5; // 画5个角
        var angle = 360 / horn; // 五个角的度数

        // 两个圆的半径
        var R = 7;
        var r = 2.8;

        for (var i = 0; i < horn; i++) {
            // 角度转弧度：角度/180*Math.PI
            // 外圆顶点坐标
            ctx.lineTo(Math.cos((18 + i * angle) / 180 * Math.PI) * R + x, -Math.sin((18 + i * angle) / 180 * Math.PI) * R + y);
            // 內圆顶点坐标
            ctx.lineTo(Math.cos((54 + i * angle) / 180 * Math.PI) * r + x, -Math.sin((54 + i * angle) / 180 * Math.PI) * r + y);
        }

        // closePath：关闭路径，将路径的终点与起点相连
        ctx.closePath();
        ctx.fillStyle = '#0000FF';
        ctx.strokeStyle = "#0000FF";
        ctx.fill();
        ctx.stroke();
    }

    // X
    function drawX(x, y) {
        ctx.font = "16px Arial";
        ctx.fillStyle = '#0000FF';
        ctx.fillText('X', x - 5, y + 6);
    }

    // 绘制颜色重置
    function colorReset() {
        ctx.font = "14px Arial";
        ctx.fillStyle = "#000";
        ctx.strokeStyle = "#000";
    }

    function drawLine(x, y, X, Y) {
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(X, Y);
        ctx.stroke();
        ctx.closePath();
    }

    //生成从minNum到maxNum的随机数
    function randomNum(minNum, maxNum) {
        switch (arguments.length) {
            case 1:
                return parseInt(Math.random() * minNum + 1, 10);
                break;
            case 2:
                return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10);
                break;
            default:
                return 0;
                break;
        }
    }

    function formatminutes(date) {
        var aa = $(".laydate-time-list li ol")[1];
        var showtime = $($(".laydate-time-list li ol")[1]).find("li");
        for (var i = 0; i < showtime.length; i++) {
            var t00 = showtime[i].innerText;
            // if (t00 != "00" && t00 != "20" && t00 != "30" && t00 != "40" && t00 != "50") {
            //     showtime[i].remove()
            // }
        }
        $($(".laydate-time-list li ol")[2]).find("li").remove();  //清空秒
    }

    function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = _queryContent.match(reg);
        if (r != null)
            return decodeURI(r[2]);
        return null;
    }

    function getTimeValue(minute) {
        if (minute >= 0 && minute <= 6) {
            minute = 0;
        } else if (minute > 6 && minute <= 12) {
            minute = 1;
        } else if (minute > 12 && minute <= 18) {
            minute = 2;
        } else if (minute > 18 && minute <= 24) {
            minute = 3;
        } else if (minute > 24 && minute <= 30) {
            minute = 4;
        } else if (minute > 30 && minute <= 36) {
            minute = 5;
        } else if (minute > 36 && minute <= 42) {
            minute = 6;
        } else if (minute > 42 && minute <= 48) {
            minute = 7;
        } else if (minute > 48 && minute <= 54) {
            minute = 8;
        } else {
            minute = 9;
        }
        return minute;
    }

    function drawData(data) {

        let time_hour = data.child.map(x => parseInt(x.TIME_HOUR));

        let time_hour_new = [];
        let val = time_hour[0];
        let end = time_hour[time_hour.length - 1];
        let diff_val = 24 - val;

        while (true) {
            if (val === end) {
                time_hour_new.push(val);
                break;
            }
            time_hour_new.push(val);
            val++;
            if (val > 23) {
                val = 0;
            }
        }

        _dataGJKZ = [];
        _dataXLXJ = [];

        _dataGJKZ = data.child.map(x => {
            let time = x.TIME.split(':');
            let hour = parseInt(x.TIME_HOUR);
            let minute = getTimeValue(parseInt(time[1]));
            let index = time_hour_new.findIndex(x => x === hour);
            return { "time": `${index}.${minute}`, "value": x.GK_VALUE };
        });
        _dataXLXJ = data.child.map(x => {
            let time = x.TIME.split(':');
            let hour = parseInt(x.TIME_HOUR);
            let minute = getTimeValue(parseInt(time[1]));
            let index = time_hour_new.findIndex(x => x === hour);
            return { "time": `${index}.${minute}`, "value": x.XL_VALUE };
        });

        init();
        drawGJKZ();
        drawXLXJ();
        colorReset();

        let topY = space - 8;
        ctx.fillText(data.master.PATIENT_NAME, xSpace * 3, topY);
        ctx.fillText(data.master.AGE, xSpace * 6, topY);
        ctx.fillText(data.master.TC, xSpace * 8, topY);
        ctx.fillText(data.master.CC, xSpace * 10, topY);
        ctx.fillText(data.master.YC, xSpace * 12, topY);
        ctx.fillText(data.master.YZ, xSpace * 14, topY);
        ctx.fillText(data.master.MATERNITY_NUMBER, xSpace * 16 + 13, topY);
        ctx.fillText(data.master.MEDICAL_RECORD_NUMBER, xSpace * 20 + 13, topY);
        $('#t_remark').text(data.master.REMARK);

        for (let i = 0; i < 24; i++) {
            $(`table tr:first td:eq(${i}) span`).text("");
            $(`table tr:eq(1) td:eq(${i})`).html("");
            $(`table tr:eq(2) td:eq(${i})`).html("");
            $(`table tr:eq(3) td:eq(${i})`).html("");
            $(`table tr:eq(4) td:eq(${i})`).html("");
        }

        for (let i = 0; i < time_hour_new.length; i++) {
            $(`table tr:first td:eq(${i}) span`).text(time_hour_new[i]);
            let item = data.child.find(x => x.TIME_HOUR == time_hour_new[i]);
            if (item) {

                //血压
                let top = "&nbsp;";
                let bottom = "&nbsp;";
                if (item.SBP) {
                    top = item.SBP;
                }
                if (item.DBP) {
                    bottom = item.DBP;
                }
                $(`table tr:eq(1) td:eq(${i})`).html(`${top}<hr />${bottom}`);

                //胎心
                $(`table tr:eq(2) td:eq(${i})`).html(`${item.FETAL_HEART}`);
                //宫缩
                $(`table tr:eq(3) td:eq(${i})`).html(`${item.CONTRACTIONS}`);
                //处理
                $(`table tr:eq(4) td:eq(${i})`).html(`${item.HANDLE}`);
            }
        }
    }

    Date.prototype.getFormatTime = function () {
        this.y = this.getFullYear(),
            this.m = (this.getMonth() + 1) < 10 ? 0 + "" + (this.getMonth() + 1) : (this.getMonth() + 1),
            this.d = this.getDate() < 10 ? 0 + "" + this.getDate() : this.getDate(),
            this.h = this.getHours() < 10 ? 0 + "" + this.getHours() : this.getHours(),
            this.f = this.getMinutes() < 10 ? 0 + "" + this.getMinutes() : this.getMinutes(),
            this.toshortdate = this.y + "-" + this.m + "-" + this.d,
            this.tolongdatetime = this.y + "-" + this.m + "-" + this.d + " " + this.h + ":" + this.f,
            this.TDate = this.y + "-" + this.m + "-" + this.d,
            this.TDateTime = this.y + "-" + this.m + "-" + this.d + "T" + this.h + ":" + this.f,
            this.getLongDate = this.y + this.M + this.d + this.h + this.m
        //this.getNowDate = this.getLongDate.replace(/(.{4})(.{2})(.{2})(.{2})(.{2})/, "$1-$2-$3 $4:$5")
        return this;
    };

    function DateTimeFitFormat(text) {
        if (!!text) {
            return text.replace('T', ' ');
        }
        return '';
    }

    $(function () {
        var laydate;
        var lay_dialog_index;

        init();

        //加载表格表单
        let tableForm = "";
        for (let i = 0; i <= _defaultRow; i++) {
            tableForm += `
                        <tr>
                                <td><input id="t-time-${i}" type="text" placeholder="检查时间" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-gkkz-${i}" type="text" placeholder="宫口扩张" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-xlxj-${i}" type="text" placeholder="先露下降" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-sbp-${i}" type="text" placeholder="收缩压" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-dbp-${i}" type="text" placeholder="舒张压" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-tx-${i}" type="text" placeholder="胎心" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-gs-${i}" type="text" placeholder="宫缩" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-cl-${i}" type="text" placeholder="处理" autocomplete="off" class="layui-input"></td>
                            </tr>`;
        }
        $('#table-form').html(tableForm);

        $('#add-one-button').click(function () {
            _defaultRow++;
            $('#table-form').append(`
                        <tr>
                                <td><input id="t-time-${_defaultRow}" type="text" placeholder="检查时间" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-gkkz-${_defaultRow}" type="text" placeholder="宫口扩张" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-xlxj-${_defaultRow}" type="text" placeholder="先露下降" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-sbp-${_defaultRow}" type="text" placeholder="收缩压" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-dbp-${_defaultRow}" type="text" placeholder="舒张压" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-tx-${_defaultRow}" type="text" placeholder="胎心" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-gs-${_defaultRow}" type="text" placeholder="宫缩" autocomplete="off" class="layui-input"></td>
                                <td><input id="t-cl-${_defaultRow}" type="text" placeholder="处理" autocomplete="off" class="layui-input"></td>
                            </tr>`)
            laydate.render({
                elem: '#t-time-' + _defaultRow
                , type: 'time'
                , format: 'HH:mm'
                , btns: ['clear', 'confirm']
                , ready: formatminutes
            });
        });

        let t_date = new Date().getFormatTime().TDateTime;
        $('#START_TIME').val(t_date);
        $('#t-time-0').val(t_date.split('T')[1]);

        $('#START_TIME').change(function () {
            $('#t-time-0').val($(this).val().split('T')[1]);
        });

        $('#print-button').click(function () {
            window.print();
        });

        $('#save-button').click(function () {

            _queryContent = $('#form1').serialize();

            let master = {
                FID: 0,
                PATIENTID: "",
                VISITID: "",
                PATIENT_NAME: GetQueryString("PATIENT_NAME"),
                AGE: GetQueryString("AGE"),
                TC: GetQueryString("TC"),
                CC: GetQueryString("CC"),
                YC: GetQueryString("YC"),
                YZ: GetQueryString("YZ"),
                MATERNITY_NUMBER: GetQueryString("MATERNITY_NUMBER"),
                MEDICAL_RECORD_NUMBER: GetQueryString("MEDICAL_RECORD_NUMBER"),
                START_TIME: DateTimeFitFormat($('#START_TIME').val()),
                REMARK: GetQueryString("REMARK"),
                CREATE_USER: ""
            };

            let child = [];
            let sort = 0;
            for (let i = 0; i <= _defaultRow; i++) {
                let time = $.trim($("#t-time-" + i).val());
                if (time) {
                    if (!_regTime.test(time)) {
                        layer.msg('时间格式不正确', { icon: 5 });
                        $('#t-time-' + i).focus().addClass('layui-form-danger');
                        return false;
                    }
                    time_arr = time.split(':');
                    if (time_arr.length === 2) {
                        child.push({
                            FRIEDMAN_ID: "",
                            SORT: sort,
                            TIME: time,
                            TIME_HOUR: time_arr[0],
                            GK_VALUE: $("#t-gkkz-" + i).val(),
                            XL_VALUE: $("#t-xlxj-" + i).val(),
                            SBP: $("#t-sbp-" + i).val(),
                            DBP: $("#t-dbp-" + i).val(),
                            FETAL_HEART: $("#t-tx-" + i).val(),
                            CONTRACTIONS: $("#t-gs-" + i).val(),
                            HANDLE: $("#t-cl-" + i).val()
                        });
                        sort++;
                    }
                }
            }
            drawData({ master: master, child: child });
            layer.close(lay_dialog_index);
        });

        $('#cancel-button').click(function () {
            layer.close(lay_dialog_index);
        });

        layui.use('layer',
            function () {
                $("#add-button").click(function () {
                    lay_dialog_index = layer.open({
                        title: '数据填写',
                        type: 1,
                        area: ['1060px', '760px'],
                        content: $('#dialog'),
                        scrollbar: false
                    });
                    layer.full(lay_dialog_index);
                });
            });

        layui.use('element', function () {
            var element = layui.element;
        });

        layui.use('laydate', function () {
            laydate = layui.laydate;
            for (let i = 0; i <= _defaultRow; i++) {
                laydate.render({
                    elem: '#t-time-' + i
                    , type: 'time'
                    , format: 'HH:mm'
                    , btns: ['clear', 'confirm']
                    , ready: formatminutes
                });
            }
        });
    })
</script>