<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>产程图</title>
    <link href="js/layui/css/layui.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
        }

        .title {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .title div:first-child {
            font-size: 18px;
        }

        .title div:nth-child(2) {
            font-size: 28px;
        }

        .friedman {
            text-align: center;
        }

        /* 附属表格 */
        .table {
            margin-top: 20px;
            table-layout: fixed;
            word-break: break-all;
        }

        .table table {
            width: 960px;
            margin: auto;
            /* border: #000 2px solid; */
            border-collapse: collapse;
        }

        .table table tr {
            height: 80px;
            text-align: center;
        }

        .table table td {
            width: 40px;
            border: #000 1px solid;
            padding: 4px;
        }

        .table table td hr {
            border-top: 1px solid #000;
        }

        .table .vertical {
            writing-mode: vertical-lr;
            letter-spacing: 2px;
        }

        .table table tr:first-child {
            text-align: left;
            height: 20px;
        }

        .table table tr:first-child td {
            border-top: none;
            border-left: none;
            border-right: none;
            border-bottom-width: 2px;
        }

        .table table tr:nth-child(5) {
            height: 330px;
        }

        .table table tr:nth-child(7) {
            text-align: left;
            vertical-align: top;
        }

        .table table tr:last-child {
            text-align: left;
            height: 40px;
        }

        .table table tr:last-child td {
            border-left: none;
            border-right: none;
            border-bottom: none;
            border-top-width: 2px;
        }

        /* 附属表格左侧文字 */
        #table-title {
            position: absolute;
            top: 650px;
            left: calc(50% - 524px);
            text-align: center;
        }

        #table-title p:nth-child(3) {
            margin-top: 38px;
        }

        #table-title p:nth-child(4) {
            margin-top: 44px;
        }

        #table-title p:nth-child(5) {
            margin-top: 100px;
        }

        #table-title p:nth-child(6) {
            margin-top: 160px;
        }

        #table-title p:nth-child(7) {
            margin-top: 80px;
        }

        #add-button {
            position: absolute;
            left: calc(50% + 310px);
        }

        #print-button {
            position: absolute;
            left: calc(50% + 405px);
        }

        #dialog {
            display: none;
            padding: 0 20px 0 20px;
        }
    </style>
    <style media="print">
        #add-button,
        #print-button {
            display: none;
        }
    </style>

    <style type="text/css">
        .layui-laydate-content>.layui-laydate-list {
            padding-bottom: 0px;
            overflow: hidden;
        }

        .layui-laydate-content>.layui-laydate-list>li {
            width: 50%
        }

        .merge-box .scrollbox .merge-list {
            padding-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="title">
        <div>
            <span>XXXXXXXXXX医院</span>
            <input id="add-button" type="button" value="数据填写" class="layui-btn layui-btn-primary" />
            <input id="print-button" type="button" value="打印" class="layui-btn layui-btn-primary" />
        </div>
        <div>产&nbsp;&nbsp;&nbsp;&nbsp;程&nbsp;&nbsp;&nbsp;&nbsp;图</div>
    </div>
    <div class="friedman">
        <canvas id="background" width="1040" height="520">
        </canvas>
    </div>
    <div class="table">
        <div id="table-title">
            <p>检查<br />时间</p>
            <p><br />血压<br />mmHg</p>
            <p>胎心<br />(次/分)</p>
            <p>宫缩</p>
            <p>处</p>
            <p>理</p>
            <p>签</p>
            <p>名</p>
        </div>
        <table>
            <tr>
                <td>23</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>78
                    <hr />130
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>98
                    <hr />160
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>140</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>18</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><span>11:11头位助产一女婴</span></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td><span>观察</span></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td colspan="24">
                    备注：
                </td>
            </tr>
            <tr>
                <td colspan="8">
                    医师：
                </td>
                <td colspan="8">
                    接产者：
                </td>
                <td colspan="8">
                    巡回：
                </td>
            </tr>
        </table>
    </div>


    <div id="dialog">
        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
            <ul class="layui-tab-title">
                <li class="layui-this">基本信息</li>
                <li>宫口扩张</li>
                <li>先露高低</li>
                <li>附属表格</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div class="layui-form">
                        <div class="layui-form-item">
                            <label class="layui-form-label">姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" value="张三" autocomplete="off" class="layui-input">
                            </div>
                            <label class="layui-form-label">年龄</label>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">胎次</label>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" class="layui-input">
                            </div>
                            <label class="layui-form-label">产次</label>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">孕次</label>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" class="layui-input">
                            </div>
                            <label class="layui-form-label">孕周</label>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">孕产号</label>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" class="layui-input">
                            </div>
                            <label class="layui-form-label">病案号</label>
                            <div class="layui-input-inline">
                                <input type="text" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <div class="layui-form" id="gkkz-form">
                    </div>
                </div>
                <div class="layui-tab-item">
                    <div class="layui-form" id="xlgd-form">
                    </div>
                </div>
                <div class="layui-tab-item">

                    <table class="layui-table" lay-skin="line">
                        <colgroup>
                            <col width="60">
                            <col width="90">
                            <col width="90">
                            <col width="90">
                            <col width="90">
                            <col width="90">
                            <col width="180">
                            <col width="90">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>检查时间</th>
                                <th>血压</th>
                                <th></th>
                                <th>胎心</th>
                                <th>宫缩</th>
                                <th>处理</th>
                                <th>签名</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="text" placeholder="检查时间" autocomplete="off" class="layui-input"
                                        style="width: 86px"></td>
                                <td>
                                    <input type="text" placeholder="收缩压" autocomplete="off" class="layui-input" style="width: 86px">
                                </td>
                                <td>
                                    <input type="text" placeholder="舒张压" autocomplete="off" class="layui-input" style="width: 86px">
                                </td>
                                <td><input type="text" placeholder="胎心" autocomplete="off" class="layui-input"
                                        style="width: 86px"></td>
                                <td><input type="text" placeholder="宫缩" autocomplete="off" class="layui-input"
                                        style="width: 86px"></td>
                                <td><input type="text" placeholder="处理" autocomplete="off" class="layui-input"></td>
                                <td><input type="text" placeholder="签名" autocomplete="off" class="layui-input"
                                        style="width: 86px"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script src="js/jquery-3.0.0.min.js"></script>
<script src="js/layui/layui.js"></script>
<script>
    var canvas;
    var ctx;
    // var margin = 20;
    var space = 20; //轴的离边距离
    var xSpace = 40;
    var width;
    var height;
    var originX;
    var originY;
    var xGridSize = 48; // x10 + 40 = height
    var yGridSize = 40; // x24 + 40 = width
    var timeCount = 24;

    // let dataGJKZ = [];
    // for (let i = 0; i < 24; i++) {
    //     if (i < 8) {
    //         dataGJKZ.push({
    //             time: i,
    //             value: null
    //         });
    //     } else {
    //         dataGJKZ.push({
    //             time: i,
    //             value: randomNum(0, 5) //Math.ceil(Math.random() * 10)
    //         });
    //     }
    // }

    // let dataXLXJ = [];
    // for (let i = 0; i < 24; i++) {
    //     dataXLXJ.push({
    //         time: i,
    //         value: randomNum(-2, 2)
    //     });
    // }

    let dataGJKZ = [{
        time: 0,
        value: null
    }, {
        time: 6.4,
        value: 3
    }, {
        time: 9,
        value: 5
    }, {
        time: 14,
        value: 7.2
    }, {
        time: 14.2,
        value: 10
    }];

    let dataXLXJ = [{
        time: 0,
        value: -3
    }, {
        time: 6.3,
        value: -2.2
    }, {
        time: 11.5,
        value: -2
    }, {
        time: 14,
        value: -2
    }, {
        time: 14.8,
        value: 5
    }];

    function init() {
        canvas = document.getElementById('background');
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        width = canvas.width - xSpace - xSpace; //减去左右两侧
        height = canvas.height - space;
        originX = xSpace;
        originY = height;
        //ctx.translate(0.5, 0.5);

        ctx.font = "14px Arial";
        ctx.lineWidth = 2;
        colorReset();

        console.log(`originX:${originX}`);
        console.log(`originY:${originY}`);
        console.log(`width:${width}`);
        console.log(`height:${height}`);

        // y轴
        drawLine(originX, originY, originX, space);
        // x轴
        drawLine(originX, originY, originX + width, originY);
        // 上横线
        drawLine(originX, space, originX + width, space);
        // 右竖线
        drawLine(originX + width, originY, originX + width, space);

        ctx.lineWidth = 1;

        // 绘制X轴方向的线
        var xCount = Math.floor(height / xGridSize);
        for (var i = 0; i < xCount; i++) {
            ctx.beginPath();
            ctx.moveTo(originX, i * xGridSize + space - 0.5);
            ctx.lineTo(originX + width, i * xGridSize + space - 0.5);
            ctx.stroke();
        }

        // 绘制Y轴方向的线
        yGridSize = Math.floor(width / timeCount);
        var yCount = Math.floor(width / yGridSize);
        for (var i = 0; i < yCount; i++) {
            ctx.beginPath();
            ctx.moveTo(i * yGridSize + xSpace - 0.5, space);
            ctx.lineTo(i * yGridSize + xSpace - 0.5, height);
            ctx.stroke();
        }
        drawTitle();
        drawGJKZ();
        drawXLXJ();
    }

    // 绘制文字及坐标值
    function drawTitle() {
        // X轴坐标值绘制
        arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
        for (var i = 0; i < arr.length; i++) {
            ctx.fillText(arr[i], i * yGridSize + 74, height + space);
        }

        // X轴上侧文字绘制
        let topY = space - 8;
        ctx.fillText('姓名：', xSpace * 2, topY);
        ctx.fillText('张三', xSpace * 3, topY);
        ctx.fillText('年龄：', xSpace * 5, topY);
        ctx.fillText('14', xSpace * 6, topY);
        ctx.fillText('胎次：', xSpace * 7, topY);
        ctx.fillText('100', xSpace * 8, topY);
        ctx.fillText('产次：', xSpace * 9, topY);
        ctx.fillText('100', xSpace * 10, topY);
        ctx.fillText('孕次：', xSpace * 11, topY);
        ctx.fillText('100', xSpace * 12, topY);
        ctx.fillText('孕周：', xSpace * 13, topY);
        ctx.fillText('100', xSpace * 14, topY);
        ctx.fillText('孕产号：', xSpace * 15, topY);
        ctx.fillText('100000000', xSpace * 16 + 13, topY);
        ctx.fillText('病案号：', xSpace * 19, topY);
        ctx.fillText('200000000', xSpace * 20 + 13, topY);


        // Y轴坐标值及文字
        var arr = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0];
        for (var i = 0; i < arr.length; i++) {
            ctx.fillText(arr[i], space, xGridSize * i + 22);
        }
        ctx.fillText('宫', 0, xGridSize + 18);
        ctx.fillText('口', 0, xGridSize + 38);
        ctx.fillText('扩', 0, xGridSize + 58);
        ctx.fillText('张', 0, xGridSize + 78);
        ctx.fillText('公', 0, xGridSize + 118);
        ctx.fillText('分', 0, xGridSize + 138);
        drawCircle(7, xGridSize + 168);
        ctx.fillText('|', 5, xGridSize + 188);
        drawCircle(7, xGridSize + 200);
        ctx.fillText('红', 0, xGridSize + 240);
        ctx.fillText('色', 0, xGridSize + 260);

        // Y轴右边坐标值及文字
        arr = ['+5', '+4', '+3', '+2', '+1', '0', '-1', '-2', '-3', '-4', '-5'];
        for (var i = 0; i < arr.length; i++) {
            ctx.fillText(arr[i], originX + width + 3, xGridSize * i + 22);
        }
        ctx.fillText('先', originX + width + space + 6, xGridSize + 18);
        ctx.fillText('露', originX + width + space + 6, xGridSize + 38);
        ctx.fillText('高', originX + width + space + 6, xGridSize + 58);
        ctx.fillText('低', originX + width + space + 6, xGridSize + 78);
        drawX(originX + width + space + 11, xGridSize + 108);
        colorReset();
        ctx.fillText('|', originX + width + space + 9, xGridSize + 128);
        drawX(originX + width + space + 11, xGridSize + 142);
        colorReset();
        ctx.fillText('蓝', originX + width + space + 6, xGridSize + 182);
        ctx.fillText('色', originX + width + space + 6, xGridSize + 202);
    }

    // 宫颈扩张曲线
    function drawGJKZ() {
        ctx.strokeStyle = "#FF0000";
        ctx.beginPath();
        let axis = [];
        for (let i = 0; i < dataGJKZ.length; i++) {
            // let x = xSpace + yGridSize * (i + 1);
            let x = dataGJKZ[i].time * yGridSize + xSpace;
            let y = height - xGridSize * dataGJKZ[i].value;
            if (i == 0) {
                ctx.moveTo(xSpace, y);
                axis.push({ x: xSpace, y: y, v: dataGJKZ[i].value });
            } else if (dataGJKZ[i].value != null) {
                ctx.lineTo(x, y);
                ctx.stroke();
                axis.push({ x: x, y: y, v: dataGJKZ[i].value });
            }
        }

        for (let i = 0; i < axis.length; i++) {
            if (axis[i].v != null) {
                drawCircle(axis[i].x, axis[i].y);
                //ctx.fillText(axis[i].v, axis[i].x, axis[i].y - 10);
            }
        }
    }

    // 先露下降曲线
    function drawXLXJ() {
        ctx.strokeStyle = "#0000FF";
        ctx.beginPath();
        let axis = [];
        for (let i = 0; i < dataXLXJ.length; i++) {
            dataXLXJ[i].value = dataXLXJ[i].value + 5;
            // let x = xSpace + yGridSize * (i + 1);
            let x = dataXLXJ[i].time * yGridSize + xSpace;
            let y = height - xGridSize * dataXLXJ[i].value;
            if (i == 0) {
                ctx.moveTo(xSpace, y);
                axis.push({ x: xSpace, y: y, v: dataXLXJ[i].value - 5 });
            } else if (dataXLXJ[i].value != null) {
                ctx.lineTo(x, y);
                ctx.stroke();
                axis.push({ x: x, y: y, v: dataXLXJ[i].value - 5 });
            }
        }

        for (let i = 0; i < axis.length; i++) {
            if (axis[i].v != null) {
                //drawStar(axis[i].x, axis[i].y);
                drawX(axis[i].x, axis[i].y);
                //ctx.fillText(axis[i].v, axis[i].x, axis[i].y - 10);
            }
        }
    }

    // 红色圆圈
    function drawCircle(x, y) {
        ctx.strokeStyle = "#FF0000";
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, 2 * Math.PI);

        // ctx.fillStyle = "#FF0000";
        // ctx.fill(); //填充实心

        ctx.stroke();
    }

    // 五角星
    function drawStar(x, y) {
        ctx.beginPath();
        var horn = 5; // 画5个角
        var angle = 360 / horn; // 五个角的度数

        // 两个圆的半径
        var R = 7;
        var r = 2.8;

        for (var i = 0; i < horn; i++) {
            // 角度转弧度：角度/180*Math.PI
            // 外圆顶点坐标
            ctx.lineTo(Math.cos((18 + i * angle) / 180 * Math.PI) * R + x, -Math.sin((18 + i * angle) / 180 * Math.PI) * R + y);
            // 內圆顶点坐标
            ctx.lineTo(Math.cos((54 + i * angle) / 180 * Math.PI) * r + x, -Math.sin((54 + i * angle) / 180 * Math.PI) * r + y);
        }

        // closePath：关闭路径，将路径的终点与起点相连
        ctx.closePath();
        ctx.fillStyle = '#0000FF';
        ctx.strokeStyle = "#0000FF";
        ctx.fill();
        ctx.stroke();
    }

    // X
    function drawX(x, y) {
        ctx.font = "16px Arial";
        ctx.fillStyle = '#0000FF';
        ctx.fillText('X', x - 5, y + 6);
    }

    // 绘制颜色重置
    function colorReset() {
        ctx.font = "14px Arial";
        ctx.fillStyle = "#000";
        ctx.strokeStyle = "#000";
    }

    function drawLine(x, y, X, Y) {
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(X, Y);
        ctx.stroke();
        ctx.closePath();
    }

    //生成从minNum到maxNum的随机数
    function randomNum(minNum, maxNum) {
        switch (arguments.length) {
            case 1:
                return parseInt(Math.random() * minNum + 1, 10);
                break;
            case 2:
                return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10);
                break;
            default:
                return 0;
                break;
        }
    }

    function formatminutes(date) {
        var aa = $(".laydate-time-list li ol")[1];
        var showtime = $($(".laydate-time-list li ol")[1]).find("li");
        for (var i = 0; i < showtime.length; i++) {
            var t00 = showtime[i].innerText;
            // if (t00 != "00" && t00 != "20" && t00 != "30" && t00 != "40" && t00 != "50") {
            //     showtime[i].remove()
            // }
        }
        $($(".laydate-time-list li ol")[2]).find("li").remove();  //清空秒
    }

    $(function () {
        init();

        //加载产程图表单
        let gkkzForm = "";
        let xlgdForm = "";
        for (let i = 0; i <= 24; i++) {
            gkkzForm += `
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label>${i}</label>
                            </div>
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input id="gkkz-${i}" type="text" placeholder="时间" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input type="text" placeholder="数值" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </div>`;
            xlgdForm += `
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label>${i}</label>
                            </div>
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input id="xlgd-${i}" type="text" placeholder="时间" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input type="text" placeholder="数值" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </div>`;
        }
        $('#gkkz-form').html(gkkzForm);
        $('#xlgd-form').html(xlgdForm);

        $('#print-button').click(function () {
            window.print();
        });

        layui.use('layer',
            function () {
                $("#add-button").click(function () {
                    layer.open({
                        title: '数据填写',
                        type: 1,
                        area: ['1060px', '760px'],
                        content: $('#dialog'),
                        btn: ['确认', '关闭'],
                        yes: function (index, layero) {
                            layer.close(index);
                        }
                    });
                });
            });

        layui.use('element', function () {
            var element = layui.element;
        });

        layui.use('laydate', function () {
            var laydate = layui.laydate;
            for (let i = 0; i <= 24; i++) {
                laydate.render({
                    elem: '#gkkz-' + i
                    , type: 'time'
                    , format: 'HH:mm'
                    , btns: ['clear', 'confirm']
                    , ready: formatminutes
                });

                laydate.render({
                    elem: '#xlgd-' + i
                    , type: 'time'
                    , format: 'HH:mm'
                    , btns: ['clear', 'confirm']
                    , ready: formatminutes
                });
            }
        });
    })
</script>